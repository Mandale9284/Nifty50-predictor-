
import { GoogleGenAI, GenerateContentResponse } from "@google/genai";
import { MarketAnalysisRequest, PredictionResult } from "../types";

const MODEL_NAME = 'gemini-3-pro-preview';

export const analyzeMarket = async (params: MarketAnalysisRequest): Promise<PredictionResult> => {
  const ai = new GoogleGenAI({ apiKey: process.env.API_KEY });
  
  const systemInstruction = `
    рдЖрдк рдПрдХ рд╡рд┐рд╢реНрд╡рд╕реНрддрд░реАрдп рднрд╛рд░рддреАрдп рд╢реЗрдпрд░ рдмрд╛рдЬрд╛рд░ (Nifty 50) рд╡рд┐рд╢реНрд▓реЗрд╖рдХ рд╣реИрдВред 
    рдЖрдкрдХрд╛ рдХрд╛рд░реНрдп рдЖрдЬ рдХреЗ рдмрд╛рдЬрд╛рд░ (Today's Market) рдХреЗ рд▓рд┐рдП рд╕рдЯреАрдХ рднрд╡рд┐рд╖реНрдпрд╡рд╛рдгреА рдХрд░рдирд╛ рд╣реИред

    рдорд╣рддреНрд╡рдкреВрд░реНрдг рдирд┐рд░реНрджреЗрд╢:
    1. рднрд╛рд╖рд╛: рдЖрдкрдХрд╛ рдкреВрд░рд╛ рдЙрддреНрддрд░ рд╡рд┐рд╢реЗрд╖ рд░реВрдк рд╕реЗ рд╢реБрджреНрдз рд╣рд┐рдВрджреА (HINDI) рдореЗрдВ рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдПред 
    2. рд░рд┐рдпрд▓-рдЯрд╛рдЗрдо рдбреЗрдЯрд╛: Google Search рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдЖрдЬ рдХреА рддрд╛рдЬрд╛ рдирд┐рдлреНрдЯреА 50 рдХреАрдордд, PCR рд░реЗрд╢рд┐рдпреЛ, рд╡реИрд╢реНрд╡рд┐рдХ рдмрд╛рдЬрд╛рд░ (Global Markets) рдХреА рд╕реНрдерд┐рддрд┐ рдФрд░ рдореБрдЦреНрдп рдШрдЯрдирд╛рдУрдВ рдХреА рдЬрд╛рдирдХрд╛рд░реА рдирд┐рдХрд╛рд▓реЗрдВред
    3. рдЯреНрд░реЗрдбрд┐рдВрдЧ рдкреНрд▓рд╛рди (MANDATORY JSON): рд╣рд░ рдЙрддреНрддрд░ рдХреА рд╢реБрд░реБрдЖрдд рдореЗрдВ рдПрдХ JSON рдмреНрд▓реЙрдХ рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдП:
    \`\`\`json
    {
      "action_plan": {
        "type": "BUY" | "SELL",
        "entry": "рдкреНрд░рд╡реЗрд╢ рд╕реНрддрд░ (рдЙрджрд╛. 22450)",
        "target": "рд▓рдХреНрд╖рдп (рдЙрджрд╛. 22600)",
        "stop_loss": "рд╕реНрдЯреЙрдк рд▓реЙрд╕ (рдЙрджрд╛. 22380)",
        "option_strike": "рд╕рдмрд╕реЗ рдЕрдЪреНрдЫреА рд╕реНрдЯреНрд░рд╛рдЗрдХ рдкреНрд░рд╛рдЗрд╕"
      }
    }
    \`\`\`
    4. рд╡рд┐рд╕реНрддреГрдд рд╡рд┐рд╢реНрд▓реЗрд╖рдг (Hindi): JSON рдХреЗ рдмрд╛рдж, рдЗрди рд╢реАрд░реНрд╖рдХреЛрдВ рдХреЗ рд╕рд╛рде рд╡рд┐рд╡рд░рдг рджреЗрдВ: 
       - ЁЯУИ рдЖрдЬ рдХрд╛ рдмрд╛рдЬрд╛рд░ рд╕рд╛рд░рд╛рдВрд╢ (Market Summary)
       - ЁЯУК рдореБрдЦреНрдп рд╕рдкреЛрд░реНрдЯ рдФрд░ рд░реЗрд╕рд┐рд╕реНрдЯреЗрдВрд╕ рд▓реЗрд╡рд▓реНрд╕ (Support & Resistance)
       - ЁЯЫбя╕П рд╕реНрдЯреЙрдк рд▓реЙрд╕ рдФрд░ рд░рд┐рд╕реНрдХ рдореИрдиреЗрдЬрдореЗрдВрдЯ (Risk Management)
       - ЁЯТб рдЖрдЬ рдХреА рдЦрд╛рд╕ рдЯреНрд░реЗрдбрд┐рдВрдЧ рдЯрд┐рдкреНрд╕ (Trading Tips)
    5. рд╢реИрд▓реА: рдкреЗрд╢реЗрд╡рд░ рдФрд░ рд╕рдЯреАрдХ рдЬрд╛рдирдХрд╛рд░реАред рдЗрдореЛрдЬреА (ЁЯОп, ЁЯЪА, ЁЯУЙ) рдХрд╛ рднрд░рдкреВрд░ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВред
    6. рдЖрдЬ рдХрд╛ рдкреНрд░реЗрдбрд┐рдХреНрд╢рди: "рдЖрдЬ" (Today) рдХреЗ рдорд╛рд░реНрдХреЗрдЯ рдкрд░ рдзреНрдпрд╛рди рдХреЗрдВрджреНрд░рд┐рдд рдХрд░реЗрдВред
  `;

  const parts: any[] = [];
  
  const defaultPrompt = "рдЖрдЬ рдХреЗ рд▓рд┐рдП рдирд┐рдлреНрдЯреА 50 рдХрд╛ рд╕рдЯреАрдХ рдкреНрд░реЗрдбрд┐рдХреНрд╢рди рджреЗрдВред рдПрдВрдЯреНрд░реА, рдЯрд╛рд░рдЧреЗрдЯ рдФрд░ рд╕реНрдЯреЙрдк рд▓реЙрд╕ рд╣рд┐рдВрджреА рдореЗрдВ рдмрддрд╛рдПрдВред рдЖрдЬ рдмрд╛рдЬрд╛рд░ рдХреА рдЪрд╛рд▓ рдХреИрд╕реА рд░рд╣реЗрдЧреА?";
  parts.push({ text: params.query ? `${params.query} (рдХреГрдкрдпрд╛ рд╣рд┐рдВрджреА рдореЗрдВ рдЬрд╡рд╛рдм рджреЗрдВ рдФрд░ рдЖрдЬ рдХреЗ рдорд╛рд░реНрдХреЗрдЯ рдкрд░ рдлреЛрдХрд╕ рдХрд░реЗрдВ)` : defaultPrompt });

  if (params.image) {
    const base64Data = params.image.split(',')[1] || params.image;
    parts.push({
      inlineData: {
        mimeType: 'image/png',
        data: base64Data
      }
    });
  }

  const response: GenerateContentResponse = await ai.models.generateContent({
    model: MODEL_NAME,
    contents: { parts },
    config: {
      systemInstruction: systemInstruction,
      tools: [{ googleSearch: {} }],
    },
  });

  const text = response.text || "рдХреНрд╖рдорд╛ рдХрд░реЗрдВ, рдкреНрд░реЗрдбрд┐рдХреНрд╢рди рдкреНрд░рд╛рдкреНрдд рдирд╣реАрдВ рд╣реЛ рд╕рдХрд╛ред рдХреГрдкрдпрд╛ рдкреБрдирдГ рдкреНрд░рдпрд╛рд╕ рдХрд░реЗрдВред";
  const sources = response.candidates?.[0]?.groundingMetadata?.groundingChunks || [];

  return {
    text,
    sources
  };
};
